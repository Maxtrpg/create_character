<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬èŒ²æå¡ï¼šå‚³å¥‡èµ·æº</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- 0. è¦–è¦ºæ ¸å¿ƒ --- */
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: rgba(15, 15, 15, 0.96);
            --gold-primary: #d4af37;
            --gold-orange: #FFEA80; 
            --gold-dim: #8a6d1c;
            --gold-glow: rgba(255, 234, 128, 0.8);
            --jade: #00bfa5;
            --jade-dark: #00695c;
            --blood: #b71c1c;
            --font-title: 'Cinzel', serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-dark);
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7)), url('images/texture_stone.webp');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #d0d0d0;
            font-family: var(--font-body);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            text-align: center;
            padding: 10px 0;
            background: linear-gradient(to bottom, #000, transparent);
            border-bottom: 2px solid var(--gold-dim);
            z-index: 10;
            flex-shrink: 0;
        }
        h1 {
            margin: 0;
            font-family: var(--font-title);
            color: var(--gold-primary);
            letter-spacing: 6px;
            text-shadow: 0 0 20px var(--gold-glow), 0 2px 0px #000;
            font-size: 2em;
            text-transform: uppercase;
        }

        /* --- Container --- */
        .creator-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 70px);
            padding: 20px 40px;
            gap: 30px;
            overflow: hidden; 
        }

        .panel {
            background: var(--panel-bg);
            background-image: url('https://www.transparenttextures.com/patterns/black-scales.png');
            border: 2px solid var(--gold-dim);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9), inset 0 0 60px rgba(0,0,0,0.8);
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 3px; }

        .panel-left { width: 340px; min-width: 340px; }
        .panel-right { width: 360px; min-width: 360px; }
        
        .panel-center {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            padding-top: 20px;
            padding-bottom: 40px;
        }

        .name-input {
            width: 50%; 
            background: transparent; border: none; border-bottom: 2px solid var(--gold-primary);
            color: var(--gold-primary); font-family: var(--font-title); font-size: 2.2em; text-align: center;
            margin-bottom: 10px; transition: 0.3s;
            text-shadow: 0 0 15px var(--gold-glow); z-index: 10;
        }
        .name-input:focus { box-shadow: 0 10px 30px -10px var(--gold-glow); outline: none; }

        /* --- å‘½é‹ä¹‹è¼ª (1.1å€) --- */
        .aztec-wheel-container {
            position: relative;
            width: 528px; height: 528px; 
            flex-shrink: 0;
            background: url('images/wheel_bg.webp') no-repeat center center;
            background-size: contain;
            border-radius: 50%;
            box-shadow: 0 0 70px rgba(0,0,0,0.9); 
            margin: 50px 0 30px 0;
        }
        .aztec-wheel-container:after {
            content:''; position:absolute; top:0; left:0; width:100%; height:100%;
            border-radius:50%; background: radial-gradient(circle, rgba(0,0,0,0.8) 40%, transparent 70%);
            z-index:-1;
        }

        .wheel-ring {
            position: absolute; top: 50%; left: 50%;
            transform-origin: 0 0;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        .ring-outer { z-index: 10; }
        .ring-inner { z-index: 20; }

        .wheel-item {
            position: absolute; 
            width: 66px; height: 66px; 
            top: -33px; left: -33px;   
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto;
            background: transparent; border: none; box-shadow: none; border-radius: 0; 
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .wheel-item img {
            width: 100%; height: 100%; object-fit: contain;
            filter: grayscale(100%) brightness(0.6) drop-shadow(0 2px 3px rgba(0,0,0,0.8)); 
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        .wheel-item:hover { z-index: 50; }
        .wheel-item:hover img { filter: grayscale(0%) brightness(1.2) drop-shadow(0 0 10px var(--jade)); transform: scale(1.2); }
        .wheel-item.active { z-index: 40; }
        .wheel-item.active img { filter: grayscale(0%) brightness(1.3) drop-shadow(0 0 15px var(--gold-primary)); transform: scale(1.4); }

        .wheel-core-display {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 220px; height: 220px; 
            z-index: 5;
            display: flex; justify-content: center; align-items: center;
        }
        .portrait-frame-circle {
            width: 100%; height: 100%; border-radius: 50%;
            overflow: hidden; background: #000; position: relative; z-index: 1;
            mask-image: radial-gradient(circle, white 70%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle, white 70%, transparent 100%);
        }
        .character-img {
            width: 100%; height: 100%; object-fit: cover;
            animation: breathe 6s ease-in-out infinite;
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        .portrait-rim {
            position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px;
            border-radius: 50%; border: 5px solid var(--gold-primary);
            box-shadow: inset 0 0 35px #000, 0 0 25px var(--gold-glow);
            z-index: 2; pointer-events: none;
        }
        .wheel-marker { display: none; }

        @keyframes breathe {
            0%, 100% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
        }

        /* --- æ¨™ç±¤èˆ‡éš¨æ©ŸæŒ‰éˆ• --- */
        .wheel-label-group {
            position: absolute; top: -60px;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            pointer-events: auto; 
        }
        .label-group-left { left: -80px; }
        .label-group-right { right: -80px; }

        .wheel-label {
            font-family: var(--font-title);
            color: var(--gold-orange); 
            font-size: 2em; 
            font-weight: 900;
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--gold-glow), 0 0 20px rgba(255, 100, 0, 0.6), 2px 2px 0px #000;
            background: transparent; padding: 0; border: none; border-radius: 0;       
            text-align: center; transition: all 0.2s ease;
            box-shadow: none; letter-spacing: 2px;
        }
        
        .btn-random {
            background: rgba(0,0,0,0.6); border: 1px solid var(--jade-dark);
            color: var(--jade); cursor: pointer; padding: 2px 10px; font-size: 0.9em;
            border-radius: 10px; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-random:hover { background: var(--jade-dark); color: #fff; border-color: var(--jade); }
        .btn-random-small {
            background: transparent; border: none; color: var(--jade); cursor: pointer; font-size: 1.2em;
            padding: 0 5px; transition: 0.2s;
        }
        .btn-random-small:hover { color: #fff; text-shadow: 0 0 5px var(--jade); transform: scale(1.2); }

        /* --- UI Controls --- */
        .section-title {
            color: var(--jade); font-family: var(--font-title);
            border-bottom: 2px solid var(--jade-dark);
            padding-bottom: 5px; margin-bottom: 12px;
            font-size: 1.1em; letter-spacing: 1px;
            text-shadow: 0 0 8px var(--jade-glow);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%; background: rgba(0,0,0,0.6); 
            border: 1px solid #444; border-left: 3px solid var(--gold-dim);
            color: #ddd; padding: 8px 10px; font-size: 0.95em; margin-bottom: 8px;
            font-family: var(--font-body); transition: 0.2s;
        }
        select:hover, input:hover { background: rgba(30,30,30,0.8); border-color: var(--gold-primary); }
        select:focus, input:focus { border-color: var(--gold-primary); box-shadow: 0 0 10px var(--gold-glow); background: #000; }

        .info-box {
            font-size: 0.9em; color: #ccc; background: rgba(0, 50, 50, 0.2); 
            padding: 12px; border: 1px solid var(--jade-dark);
            margin-top: 5px; line-height: 1.6; white-space: pre-wrap;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .highlight { color: var(--gold-primary); font-weight: bold; }
        .wp-cost { color: #ffeb3b; font-size: 0.85em; background: rgba(0,0,0,0.5); padding: 1px 6px; border-radius: 3px; border: 1px solid #555; margin-right: 5px; }

        .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .skill-check {
            font-size: 0.85em; padding: 8px; background: #1a1a1a; border: 1px solid #333; 
            cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 5px; color: #888; transition: 0.2s;
        }
        .skill-check.active { 
            border-color: var(--jade); background: rgba(0, 191, 165, 0.1); color: #fff; 
            box-shadow: 0 0 8px var(--jade-glow);
        }
        /* é–å®šçš„æŠ€èƒ½ (è–©æ»¿) */
        .skill-check.locked {
            border-color: var(--gold-dim); background: rgba(212, 175, 55, 0.2); 
            pointer-events: none; /* ç¦æ­¢é»æ“Šå–æ¶ˆ */
            opacity: 1; 
        }
        .skill-check.locked span::after {
            content: " (å¿…ä¿®)"; font-size: 0.8em; color: var(--gold-dim);
        }
        .skill-val { font-size: 0.9em; color: var(--gold-dim); font-weight: bold; }
        .skill-check.active .skill-val { color: var(--gold-primary); }

        .tag { 
            font-size: 0.8em; padding: 4px 8px; background: #222; border: 1px solid #444; 
            display: inline-flex; align-items: center; gap:5px; margin: 2px; color: #bbb;
        }
        .tag.removable:hover { border-color: var(--blood); color: #fff; cursor: pointer; }
        .tag.item { width: 100%; border-color: #333; justify-content: space-between; background: rgba(0,0,0,0.3); }
        .tag.bonus { border-color: var(--gold-dim); background: rgba(212, 175, 55, 0.1); color: var(--gold-orange); width: 100%; justify-content: space-between; }

        .attr-row { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px dashed #333; padding: 4px 0; margin-bottom: 4px;
        }
        .stat-input { width: 45px !important; text-align: center; border: 1px solid #444 !important; color: var(--gold-primary) !important; font-weight: bold; background: #000 !important; padding: 2px !important; }
        
        .btn-group { display:flex; gap:10px; justify-content:center; margin-top:20px; width: 80%; }
        .btn-finish {
            flex:1;
            background: linear-gradient(45deg, #8a0303, #500);
            border: 2px solid #ff4444; color: #fff;
            font-family: var(--font-title); font-size: 1.2em; padding: 12px;
            cursor: pointer; letter-spacing: 2px; 
            box-shadow: 0 0 20px rgba(138, 3, 3, 0.6);
            transition: 0.3s; position: relative; z-index: 100;
        }
        .btn-finish:hover { 
            background: linear-gradient(45deg, #b30404, #700);
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.8);
            transform: scale(1.02);
        }
        .btn-pdf {
            flex:1;
            background: linear-gradient(45deg, #d4af37, #8a6d1c);
            border: 2px solid #fff; color: #000;
            font-family: var(--font-title); font-size: 1.2em; padding: 12px;
            cursor: pointer; letter-spacing: 2px; font-weight: bold;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            transition: 0.3s; position: relative; z-index: 100;
        }
        .btn-pdf:hover {
            background: linear-gradient(45deg, #ffd700, #b8860b);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            transform: scale(1.02);
        }

        .hud { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: auto; border-top: 2px solid var(--gold-dim); padding-top: 15px;}
        .hud-box { text-align: center; background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #444; }
        .hud-val { display: block; font-size: 1.2em; color: var(--gold-primary); font-family: var(--font-title); }
        .hud-label { font-size: 0.6em; color: var(--jade); letter-spacing: 1px; }

        /* --- PDF Preview Modal --- */
        #pdf-preview-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; overflow: auto;
        }
        #pdf-preview-modal.show { display: flex; }
        
        .pdf-preview-container {
            width: 210mm; min-height: 297mm; padding: 15mm;
            background: #111; border: 2px solid var(--gold-dim);
            box-shadow: 0 0 50px rgba(0,0,0,1); color: #ddd;
            font-family: 'Noto Sans TC', sans-serif; position: relative; margin: 20px 0; transform-origin: top center;
        }
        .pdf-toolbar { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10000; }
        .tool-btn { padding: 10px 20px; font-size: 1.2em; cursor: pointer; font-family: var(--font-title); border: 1px solid #fff; color: #fff; background: #333; }
        .tool-btn.download { background: var(--gold-primary); border-color: var(--gold-orange); color: #000; }

        .pdf-header { text-align: center; border-bottom: 3px double var(--gold-primary); margin-bottom: 20px; padding-bottom: 10px; }
        .pdf-title { font-family: var(--font-title); font-size: 3em; color: var(--gold-orange); margin: 0; text-transform: uppercase; }
        .pdf-subtitle { color: var(--jade); font-size: 1.5em; margin-top: 5px; font-weight: bold; }
        .pdf-grid { display: grid; grid-template-columns: 1fr 1.8fr; gap: 25px; }
        .pdf-section { background: rgba(255,255,255,0.03); border: 1px solid #444; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .pdf-section h3 { color: var(--gold-primary); border-bottom: 1px solid #666; padding-bottom: 5px; margin-top: 0; font-family: var(--font-title); font-size: 1.4em; }
        .pdf-attr-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 6px 0; font-size: 1.1em; }
        .pdf-attr-name { font-weight: bold; color: #bbb; }
        .pdf-attr-val { color: var(--gold-orange); font-weight: bold; font-family: var(--font-title); font-size: 1.2em; }
        .pdf-stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-top: 10px; }
        .pdf-stat-box { border: 1px solid var(--jade-dark); padding: 8px; background: rgba(0,50,50,0.2); }
        .pdf-stat-val { font-size: 1.8em; color: #fff; display: block; font-weight: bold; font-family: var(--font-title); }
        .pdf-stat-label { font-size: 0.8em; color: var(--jade); letter-spacing: 1px; }
        .pdf-skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.95em; }
        .pdf-skill-item { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px solid #333; }
        .pdf-skill-item.trained { color: var(--gold-orange); font-weight: bold; background: rgba(212, 175, 55, 0.1); border: 1px solid var(--gold-dim); }
        .pdf-ability-box { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dotted #444; }
        .pdf-ability-name { color: var(--jade); font-weight: bold; margin-bottom: 5px; font-size: 1.1em; }
        .pdf-ability-desc { font-size: 0.9em; line-height: 1.6; color: #ccc; text-align: justify; }
        .pdf-inventory { font-size: 0.9em; display: flex; flex-wrap: wrap; gap: 8px; }
        .pdf-item { border: 1px solid #555; padding: 4px 10px; background: #222; border-radius: 4px; color: #ddd; }
    </style>
</head>
<body onload="updateStatsAndSkills()">

<header>
    <h1>é¦¬èŒ²æå¡ï¼šå‚³å¥‡èµ·æº</h1>
</header>

<div class="creator-container">
    
    <div class="panel panel-left">
        <div class="control-group">
            <div class="section-title">I. èº«ä»½ç´°ç¯€</div>
            <div id="subrace-container" style="display:none; margin-top:15px;">
                <label style="font-size:0.8em; color:var(--jade);">è¡€è„ˆåˆ†æ”¯ (äºç¨®)</label>
                <select id="subrace-select" onchange="updateRaceAbility()"></select>
            </div>
            <div class="info-box" id="race-ability-box" style="margin-top:10px;"></div>
        </div>

        <div class="control-group">
            <div class="section-title">II. è·æ¥­å°ˆç²¾</div>
            <div id="hero-ability-container">
                <label style="font-size:0.8em; color:var(--jade);">è‹±é›„èƒ½åŠ› (èµ·å§‹å°ˆé•·)</label>
                <select id="hero-ability-select" onchange="updateHeroDesc()"></select>
                <div class="info-box" id="hero-desc"></div>
            </div>

            <div id="extra-trait-container" style="display:none; margin-top:12px;">
                <label style="font-size:0.8em; color:var(--jade);" id="extra-trait-label">é¡å¤–ç‰¹æ€§</label>
                <select id="extra-trait-select" onchange="updateExtraTrait()"></select>
                <div class="info-box" id="extra-desc"></div>
            </div>

            <div id="spell-selector" style="display:none; margin-top:18px;">
                <div class="section-title" style="font-size:1em; border-bottom:none;">æ³•è¡“æ›¸</div>
                <div style="font-size:0.85em; margin-bottom:5px;">0éšæˆ²æ³• <span id="cnt-t0" style="color:var(--gold-primary)">0/3</span></div>
                <div class="tag-container" id="grid-t0"></div>
                <div style="font-size:0.85em; margin:12px 0 5px;">1éšæ³•è¡“ <span id="cnt-t1" style="color:var(--gold-primary)">0/3</span></div>
                <div class="tag-container" id="grid-t1"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="section-title">III. å±¬æ€§èˆ‡å¹´é½¡</div>
            <div id="attr-inputs"></div>
            <div style="margin-top:12px; display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.9em; color:var(--gold-dim);">å¹´é½¡:</span>
                <select id="age-select" onchange="updateStatsAndSkills()" style="flex:1;">
                    <option value="young">å°‘å¹´ (æ•+1 é«”+1)</option>
                    <option value="adult" selected>æˆå¹´ (æ¨™æº–)</option>
                    <option value="old">è€å¹´ (åŠ›æ•é«”-2 æ™ºæ„+1)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="panel-center">
        <input type="text" class="name-input" id="char-name" placeholder="è¼¸å…¥å‚³å¥‡ä¹‹å">
        
        <div class="aztec-wheel-container">
            <div class="wheel-label-group label-group-left">
                <div class="wheel-label" id="race-label-display">äººé¡</div>
                <button class="btn-random" onclick="randomizeRace()">ğŸ² éš¨æ©Ÿæ—è£”</button>
            </div>
            
            <div class="wheel-label-group label-group-right">
                <div class="wheel-label" id="class-label-display">æˆ°å£«</div>
                <button class="btn-random" onclick="randomizeClass()">ğŸ² éš¨æ©Ÿè·æ¥­</button>
            </div>

            <div class="wheel-ring ring-outer" id="class-ring"></div>
            <div class="wheel-ring ring-inner" id="race-ring"></div>
            
            <div class="wheel-core-display">
                <div class="portrait-frame-circle">
                    <img id="char-img" class="character-img" src="" alt="Character Portrait">
                </div>
                <div class="portrait-rim"></div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-finish" onclick="downloadFVTTJson()">åŒ¯å‡º JSON (FVTT)</button>
            <button class="btn-pdf" onclick="openPDFPreview()">åŒ¯å‡º PDF è§’è‰²å¡</button>
        </div>
    </div>

    <div class="panel panel-right">
        
        <div class="control-group">
            <div class="section-title">IV. æŠ€èƒ½ <span id="skill-pts" style="float:right; font-size:0.8em; color:#888;"></span></div>
            <div style="font-size:0.8em; color:var(--jade); margin-bottom:8px;">æ ¸å¿ƒæŠ€èƒ½ (é¸ 6 é …)</div>
            <div id="core-skill-list" class="skill-grid"></div>
            
            <div style="font-size:0.8em; color:var(--gold-primary); margin-top:18px; margin-bottom:8px; border-top:1px solid #333; padding-top:8px;">è‡ªç”±å—è¨“ / å¤©è³¦</div>
            <div style="display:flex; gap:8px;">
                <select id="free-skill-select"></select>
                <button onclick="addFreeSkill()" style="background:#333; border:1px solid #555; color:#fff; cursor:pointer; padding:0 15px;">+</button>
            </div>
            <div id="free-skill-list" class="tag-container"></div>
        </div>

        <div class="control-group">
            <div class="section-title">V. è£å‚™</div>
            <select id="equip-select" onchange="updateInventory()"></select>
            <div id="weapon-choice-container" style="display:none; margin-top:10px;">
                <label style="font-size:0.8em; color:var(--jade);">é¸æ“‡ä¸»æ­¦å™¨:</label>
                <select id="weapon-select" onchange="updateInventory()"></select>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                <div style="flex:1">
                    <label style="font-size:0.8em; color:#888;">éŠ€å¹£</label>
                    <input type="number" id="money-input" value="0">
                </div>
                <div style="flex:1">
                    <label style="font-size:0.8em; color:#888;">å£ç³§</label>
                    <input type="number" id="food-input" value="0">
                </div>
            </div>
            <div id="resource-hint" style="font-size:0.8em; color:var(--gold-dim); margin-bottom:10px;"></div>

            <div style="margin-top:15px;">
                <div style="font-size:0.85em; color:var(--jade); margin-bottom:6px; display:flex; justify-content:space-between;">ç´€å¿µç‰© <button class="btn-random-small" onclick="randomizeTrait('memento')">ğŸ²</button></div>
                <select id="memento-select" onchange="handleCustomInput('memento')"></select>
                <input type="text" id="memento-custom" style="display:none; margin-top:6px; border-color:var(--jade);" placeholder="è¼¸å…¥è‡ªè¨‚ç´€å¿µç‰©..." oninput="updateInventory()">
            </div>

            <div style="margin-top:15px;">
                <div style="font-size:0.85em; color:#888; margin-bottom:6px;">ç‰©å“æ¸…å–®</div>
                <div id="inventory-list" style="max-height:100px; overflow-y:auto; padding-right:5px;"></div>
            </div>
        </div>

        <div class="control-group">
            <div class="section-title">VI. ç‰¹å¾µ</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <label style="font-size:0.8em; color:#888;">å¼±é»</label>
                <button class="btn-random-small" onclick="randomizeTrait('weakness')">ğŸ²</button>
            </div>
            <select id="weakness-select" onchange="handleCustomInput('weakness')"></select>
            <input type="text" id="weakness-custom" style="display:none;" placeholder="è¼¸å…¥è‡ªè¨‚å¼±é»...">
            
            <div style="display:flex; justify-content:space-between; margin-top:8px; margin-bottom:2px;">
                <label style="font-size:0.8em; color:#888;">å¤–è§€</label>
                <button class="btn-random-small" onclick="randomizeTrait('appearance')">ğŸ²</button>
            </div>
            <select id="appearance-select" onchange="handleCustomInput('appearance')"></select>
            <input type="text" id="appearance-custom" style="display:none;" placeholder="è¼¸å…¥è‡ªè¨‚å¤–è§€...">
        </div>

        <div class="hud">
            <div class="hud-box"><span class="hud-val" id="val-hp">--</span><span class="hud-label">HP</span></div>
            <div class="hud-box"><span class="hud-val" id="val-wp">--</span><span class="hud-label">WP</span></div>
            <div class="hud-box"><span class="hud-val" id="val-move">--</span><span class="hud-label">MOV</span></div>
            <div class="hud-box"><span class="hud-val" id="val-enc">--</span><span class="hud-label">ENC</span></div>
            <div class="hud-box"><span class="hud-val" id="val-dmg" style="font-size:0.9em; padding-top:3px;">-</span><span class="hud-label">DMG</span></div>
        </div>

        <div id="spell-summary" style="margin-top:15px; display:none; background:rgba(0,0,0,0.4); padding:10px; border:1px solid var(--gold-dim);">
            <div style="font-size:0.85em; color:var(--gold-primary);">å·²è¨˜æ†¶æ³•è¡“</div>
            <div id="spell-tags" class="tag-container"></div>
        </div>

    </div>
</div>

<div id="pdf-preview-modal">
    <div class="pdf-toolbar">
        <button class="tool-btn" onclick="closePreview()">é—œé–‰é è¦½</button>
        <button class="tool-btn download" onclick="confirmDownloadPDF()">ä¸‹è¼‰ PDF</button>
    </div>
    
    <div id="pdf-content" class="pdf-preview-container">
        <div class="pdf-header">
            <h1 class="pdf-title" id="pdf-char-name">NAME</h1>
            <div class="pdf-subtitle" id="pdf-char-desc">Race / Profession</div>
        </div>
        
        <div class="pdf-grid">
            <div>
                <div class="pdf-section">
                    <h3>å±¬æ€§ Attributes</h3>
                    <div id="pdf-attrs"></div>
                </div>
                <div class="pdf-section">
                    <h3>ç‹€æ…‹ Vitals</h3>
                    <div class="pdf-stat-grid">
                        <div class="pdf-stat-box"><span class="pdf-stat-val" id="pdf-hp"></span><span class="pdf-stat-label">HP (ç”Ÿå‘½)</span></div>
                        <div class="pdf-stat-box"><span class="pdf-stat-val" id="pdf-wp"></span><span class="pdf-stat-label">WP (æ„å¿—)</span></div>
                        <div class="pdf-stat-box"><span class="pdf-stat-val" id="pdf-mov"></span><span class="pdf-stat-label">MOV (ç§»å‹•)</span></div>
                        <div class="pdf-stat-box"><span class="pdf-stat-val" id="pdf-enc"></span><span class="pdf-stat-label">ENC (è² é‡)</span></div>
                        <div class="pdf-stat-box" style="grid-column: span 2"><span class="pdf-stat-val" id="pdf-dmg"></span><span class="pdf-stat-label">DMG åŠ å€¼ (åŠ›/æ•)</span></div>
                    </div>
                </div>
                <div class="pdf-section">
                    <h3>ç‰¹å¾µ Traits</h3>
                    <div id="pdf-traits"></div>
                </div>
            </div>

            <div>
                <div class="pdf-section">
                    <h3>æŠ€èƒ½ Skills</h3>
                    <div class="pdf-skill-list" id="pdf-skills"></div>
                </div>
                
                <div class="pdf-section">
                    <h3>èƒ½åŠ› Abilities</h3>
                    <div id="pdf-abilities"></div>
                </div>

                <div class="pdf-section">
                    <h3>è£å‚™ Inventory</h3>
                    <div class="pdf-inventory" id="pdf-gear"></div>
                    <div style="margin-top:10px; border-top:1px dashed #555; padding-top:5px;">
                        <span style="margin-right:15px; color:#d4af37;">éŠ€å¹£: <span id="pdf-money">0</span></span>
                        <span style="color:#d4af37;">å£ç³§: <span id="pdf-food">0</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ================= å®Œæ•´è³‡æ–™åº« ================= */
    const RACES = {
        human: { 
            name: "äººé¡", id: "human", baseMove: 10,
            ability: "<span class='highlight'>ã€é€šæ¬Šé”è®Šã€‘</span><br><span class='wp-cost'>WP: 3</span><br>ç•¶ä½ é€²è¡ŒæŠ€èƒ½æª¢å®šæ™‚ï¼Œä½ å¯ä»¥é¸æ“‡ä½¿ç”¨å…¶ä»–æŠ€èƒ½é€²è¡Œæª¢å®šã€‚",
            subraces: { 
                maztican: {name:"é¦¬èŒ²æå¡äºº (æ„å¿—+1)",id:"maztican",bonus:{WIL:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>æ„å¿—+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"}, 
                payit: {name:"å¸•ä¼Šç‰¹äºº (æ™ºåŠ›+1)",id:"payit",bonus:{INT:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>æ™ºåŠ›+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"}, 
                kulkata: {name:"åº«å¡”å¡äºº (åŠ›é‡+1)",id:"kulkata",bonus:{STR:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>åŠ›é‡+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"}, 
                itza: {name:"ä¼Šå¯Ÿäºº (é­…åŠ›+1)",id:"itza",bonus:{CHA:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>é­…åŠ›+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"}, 
                dog: {name:"ç‹—æ°‘ (é«”è³ª+1)",id:"dog",bonus:{CON:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>é«”è³ª+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"}, 
                green: {name:"ç¶ æ°‘ (æ•æ·+1)",id:"green",bonus:{AGL:1},ability:"ä½ çš„åˆå§‹ <span class='highlight'>æ•æ·+1</span>ã€‚ï¼ˆä¸Šé™ç‚º18ï¼‰"} 
            } 
        },
        halfling: { name: "åŠèº«äºº", id: "halfling", baseMove: 8, extraSkill: "åº«æ‹‰é‡Œ", ability: "<span class='highlight'>ã€å‹•å¦‚è„«å…”ã€‘</span><br><span class='wp-cost'>WP: 3</span> é–ƒé¿ç²å„ªå‹¢ã€‚<br><span class='highlight'>ã€åº«æ‹‰é‡Œè£½ä½œã€‘</span> å—è¨“ã€åº«æ‹‰é‡Œã€‘æŠ€èƒ½ã€‚" },
        elf: { name: "ç²¾éˆ", id: "elf", baseMove: 10, ability: "<span class='highlight'>ã€å¿ƒå¦‚æ­¢æ°´ã€‘</span> çŸ­ä¼‘å†¥æƒ³é¡å¤–å›å¾©HP/WPã€‚", subraces: { earth: {name:"åœŸç²¾éˆ",id:"earth", ability:"<span class='highlight'>ã€æ³¥åœŸçš®è†šã€‘</span> éˆæ“Šè­·ç”²+2ï¼Œç•å¯’ã€‚"}, wood: {name:"æœ¨ç²¾éˆ",id:"wood", ability:"<span class='highlight'>ã€æ¨¹è³ªçš®è†šã€‘</span> ç©¿åˆºè­·ç”²+2ï¼Œç•ç«ã€‚"}, gold: {name:"é‡‘ç²¾éˆ",id:"gold", ability:"<span class='highlight'>ã€é‡‘å±¬çš®è†šã€‘</span> ç©¿åˆºè­·ç”²+2ï¼Œç•ç«ã€‚"} } },
        dwarf: { name: "çŸ®äºº", id: "dwarf", baseMove: 8, ability: "<span class='highlight'>ã€åˆ»éª¨éŠ˜å¿ƒã€‘</span><br><span class='wp-cost'>WP: 3</span> å°ä»‡æ•µæ”»æ“Šç²å„ªå‹¢ã€‚<br><span class='highlight'>ã€æ²™æ¼ è€æ€§ã€‘</span><br><span class='wp-cost'>WP: 2</span> æŠµæŠ—é£¢é¤“/ç¡çœ ä¸è¶³ã€‚" },
        eagle: { name: "é·¹äºº", id: "eagle", baseMove: 12, ability: "<span class='highlight'>ã€éŠ³çœ¼ã€‘</span> é è·ç„¡åŠ£å‹¢ã€‚<br><span class='highlight'>ã€é£›ç¿¼ã€‘</span><br><span class='wp-cost'>WP: 2</span> æˆ°é¬¥ä¸­é£›è¡Œã€‚" },
        lizard: { name: "èœ¥èœ´äºº", id: "lizard", baseMove: 10, ability: "<span class='highlight'>ã€å±æ°£ã€‘</span><br><span class='wp-cost'>WP: 1</span> æ°´ä¸‹é–‰æ°£ã€‚<br><span class='highlight'>ã€è‚‰é£Ÿè€…ã€‘</span><br><span class='wp-cost'>WP: 3</span> æ’•å’¬å›è¡€ï¼Œä¸åƒè‚‰æœƒæ†¤æ€’ã€‚" },
        panther: { 
            name: "è±¹äºº", id: "panther", baseMove: 12, 
            ability: "<span class='highlight'>ã€å¢æ—ä¼æ“Šã€‘</span><br><span class='wp-cost'>WP: 2</span> å¢æ—éš±åŒ¿ç²å„ªå‹¢ã€‚", 
            subraces: { 
                hunter: {name:"ç‹©è±¹äºº", id:"hunter", ability:"<span class='highlight'>ã€ç‹©çµæœ¬èƒ½ã€‘</span><br><span class='wp-cost'>WP: 3</span> é–å®šçµç‰©ç²å„ªå‹¢ã€‚"}, 
                ocelot: {name:"è±¹è²“äºº", id:"ocelot", ability:"<span class='highlight'>ã€è¿…æ·æ”€çˆ¬ã€‘</span><br><span class='wp-cost'>WP: 2</span> æ”€çˆ¬æª¢å®šç²å„ªå‹¢ã€‚"} 
            } 
        },
        frog: { name: "è›™äºº", id: "frog", baseMove: 10, ability: "<span class='highlight'>ã€çŒ›åŠ›å½ˆè·³ã€‘</span><br><span class='wp-cost'>WP: 3</span> è·³èºæ”»æ“Šç²å„ªå‹¢ã€‚<br><span class='highlight'>ã€ä¼‘è²ç¾è­½ã€‘</span><br><span class='wp-cost'>WP: 2</span> ç¤¾äº¤æª¢å®šç²å„ªå‹¢ã€‚" }
    };

    const PROFESSIONS = {
        artisan: { name: "å·¥åŒ ", id: "artisan", attr: "STR", resource: "1D8 é£Ÿç‰©, 1D8 éŠ€å¹£", skills: ["å·¥è—", "å·§æ‰‹", "èª¿æŸ¥", "å¾’æ‰‹", "æ–§", "æ£æ£’", "åŠ", "å°åˆ€"], heroAbilities: {a:"ã€é›åŒ å¤§å¸«ã€‘<span class='wp-cost'>WP: 3</span> éŠ³åŒ–æ­¦å™¨ã€‚", b:"ã€æœ¨åŒ å¤§å¸«ã€‘<span class='wp-cost'>WP: 1</span> ç ´é–€æˆ–æ‰“é€ æœ¨å™¨ã€‚", c:"ã€çš®åŒ å¤§å¸«ã€‘è£½ä½œç¸çš®ç”²ã€‚", d:"ã€ç¾½åŒ å¤§å¸«ã€‘è£½ä½œç¾½æ¯›è­·èº«ç¬¦ã€‚"}, gear: [{name:"1.åŠ/é›é€ ",items:["é¦¬å¡åŠ","æ£‰ç”²","é›åŒ å·¥å…·","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.æ£’/æœ¨å·¥",items:["ç¢éª¨æ£’","æ£‰ç”²","æœ¨åŒ å·¥å…·","ç«ç‚¬","10ç±³éº»ç¹©","æ‰“ç«åŒ£"]},{name:"3.æ–§/çš®åŒ ",items:["é»‘æ›œçŸ³æ–§","ç¸çš®ç”²","çš®åŒ å·¥å…·","æç‡ˆ","ç‡ˆæ²¹","æ‰“ç«åŒ£"]},{name:"4.åˆ€/ç¹”å¸ƒ",items:["é»‘æ›œçŸ³å°åˆ€","æ£‰ç”²","ç¹”å¸ƒå·¥å…·","ç«ç‚¬","æ¯›æ¯¯","æ‰“ç«åŒ£"]}] },
        hunter: { name: "çµäºº", id: "hunter", attr: "AGL", resource: "1D8 é£Ÿç‰©, 1D6 éŠ€å¹£", skills: ["é«”æ“", "ç‹©çµ", "éš±åŒ¿", "å¯Ÿè¦º", "æ±‚ç”Ÿ", "å°åˆ€", "å¼“", "å¹ç®­"], heroAbilities: {a:"ã€å‹•ç‰©å¤¥ä¼´ã€‘<span class='wp-cost'>WP: 3</span> æ“æœ‰ä¸€éš»åµæŸ¥èˆ‡åŠ©æˆ°å‹•ç‰©ã€‚", b:"ã€é›™é‡å°„æ“Šã€‘<span class='wp-cost'>WP: 3</span> å¼“/å¹ç®­ä¸€æ¬¡å°„å…©ç™¼ã€‚", c:"ã€é™·é˜±å¤§å¸«ã€‘èŠ±æ™‚é–“è£½ä½œå„ç¨®é™·é˜±ã€‚"}, gear: [{name:"1.å¼“ç®­",items:["å°åˆ€","æˆ°å¼“","ç®­è¢‹","ç¸çš®ç”²","ç¡è¢‹","ç«ç‚¬","æ‰“ç«åŒ£","ç¹©ç´¢","é™·é˜±"]},{name:"2.æŠ•çŸ³",items:["å°åˆ€","æŠ•çŸ³ç¹©","å½ˆä¸¸","ç¸çš®ç”²","ç¡è¢‹","ç«ç‚¬","æ‰“ç«åŒ£","ç¹©ç´¢","é‡£ç«¿"]},{name:"3.å¹ç®­",items:["çŸ­åŠ","å¹ç®­ç­’","å¹ç®­","ç¸çš®ç”²","ç¡è¢‹","ç«ç‚¬","æ‰“ç«åŒ£","ç¹©ç´¢","é™·é˜±"]}] },
        bard: { name: "è©©äºº", id: "bard", attr: "CHA", resource: "1D6 é£Ÿç‰©, 1D8 éŠ€å¹£", skills: ["é«”æ“", "é–ƒé¿", "èªè¨€", "ç¥•èå‚³èªª", "æ¬ºç", "è¡¨æ¼”", "éŠèªª", "å°åˆ€"], heroAbilities: {a:"ã€éŸ³æ¨‚å®¶ã€‘<span class='wp-cost'>WP: 3</span> ç›Ÿå‹å„ªå‹¢æˆ–æ•µäººåŠ£å‹¢ã€‚",b:"ã€é Œç¥æ›²ã€‘<span class='wp-cost'>WP: 3</span> ç¥ˆç¦±ç²ç¥è³œã€‚",c:"ã€æˆ°æ­Œã€‘<span class='wp-cost'>WP: 3</span> æ¶ˆé™¤ç‹€æ…‹å›WPã€‚"}, gear: [{name:"1.éª¨éŠ¼",items:["éª¨éŠ¼","å°åˆ€","æ²¹ç‡ˆ","ç‡ˆæ²¹","æ‰“ç«åŒ£"]},{name:"2.é•·ç¬›",items:["é•·ç¬›","å°åˆ€","ç¹©ç´¢","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"3.è™Ÿè§’",items:["è™Ÿè§’","å°åˆ€","ç«ç‚¬","æ‰“ç«åŒ£"]}] },
        warrior: { name: "æˆ°å£«", id: "warrior", attr: "STR", resource: "1D6 é£Ÿç‰©, 1D6 éŠ€å¹£", skills: ["é–ƒé¿", "å¾’æ‰‹", "æ–§", "æ£æ£’", "çŸ›", "åŠ", "å¼“", "æŠ•æ§å™¨"], heroAbilities: {a:"ã€è€å…µã€‘<span class='wp-cost'>WP: 1</span> ä¿ç•™å…ˆæ”»ï¼Œæ­¦å™¨æŠ€èƒ½+1ã€‚",b:"ã€ç‹‚æš´ã€‘<span class='wp-cost'>WP: 3</span> ç²æ†¤æ€’ï¼Œæ”»æ“Šå„ªå‹¢å¢å‚·ã€‚",c:"ã€é›™é‡æ–¬æ“Šã€‘<span class='wp-cost'>WP: 3</span> åŒæ™‚æ”»æ“Šå…©äººã€‚"}, 
            gear: [
                {name:"1.è¿‘æˆ°", choices:["é¦¬å¡åŠ","éŠ…æ–§","ç¢éª¨æ£’"], items:["åœ“ç›¾","çš®é©æˆ°ç”²","ç«ç‚¬","æ‰“ç«åŒ£"]},
                {name:"2.è¼•è£", choices:["é¦¬å¡çŸ­åŠ","é»‘æ›œçŸ³æ–§","æŠ•å°„æ¨™æ§"], items:["æŠ•æ§å™¨","é»‘æ›œçŸ³ç®­è¢‹","æ£‰ç”²","ç«ç‚¬","æ‰“ç«åŒ£"]},
                {name:"3.é•·æŸ„", items:["æœ¨çŸ›","çš®é©æˆ°ç”²","æœ¨è£½æˆ°ç›”","æ‰“ç«åŒ£"]}
            ] 
        },
        knight: { name: "é¨å£«", id: "knight", attr: "STR", resource: "1D6 é£Ÿç‰©, 1D12 éŠ€å¹£", skills: ["é‡ç¸çŸ¥è­˜", "ç¥•èå‚³èªª", "è¡¨æ¼”", "éŠèªª", "æ£æ£’", "çŸ›", "åŠ", "æŠ•æ§å™¨"], heroAbilities: {a:"ã€å®ˆè­·è€…ã€‘<span class='wp-cost'>WP: 2</span> ç‚ºç›Ÿå‹æ“‹åˆ€ã€‚",b:"ã€èˆ‰ç›¾æ ¼æ“‹ã€‘<span class='wp-cost'>WP: 3</span> ç›¾æ“‹ç²å„ªå‹¢ã€‚",c:"ã€å …å¼·é˜²ç¦¦ã€‘<span class='wp-cost'>WP: 3</span> åæ‡‰æ ¼æ“‹ã€‚"}, extraLabel:"é¨å£«åœ˜", extraOptions:{eagle:{name:"é·¹é¨å£«åœ˜",desc:"<span class='highlight'>ã€ç¾½çˆ¶ä¹‹ç¥ç¦ã€‘</span> æ­»äº¡æ™‚å¾©æ´»ä¸€æ¬¡ã€‚",addSkills:[]}, jaguar:{name:"è±¹é¨å£«åœ˜",desc:"<span class='highlight'>ã€å™¬å¿ƒè€…ä¹‹æ€’ã€‘</span> æ­»äº¡æ™‚å¿ƒè‡Ÿè‡ªçˆ†ã€‚",addSkills:[]}}, 
            gear: [
                {name:"é¨å£«æ¨™æº–", choices:["é¦¬å¡åŠ","é¦¬å¡çŸ­åŠ","éŠ…æ–§","ç¢éª¨æ£’","æœ¨çŸ›"], items:["æŠ•æ§å™¨","æŠ•å°„æ¨™æ§","åœ“ç›¾","æœ¨è£½æˆ°ç›”","ç«ç‚¬","æ‰“ç«åŒ£"]}
            ]
        },
        shaman: { name: "è–©æ»¿", id: "shaman", attr: "WIL", resource: "1D6 é£Ÿç‰©, 1D8 éŠ€å¹£", skills: ["é–ƒé¿", "æ£æ£’"], heroAbilities: {a:"ã€é­”æ³•ã€‘èº«ç‚ºè–©æ»¿ï¼Œä½ å‰µè§’æ™‚ä¸æœƒç²å¾—è‹±é›„èƒ½åŠ›ï¼Œè€Œæ˜¯å¯ä»¥æ–½æ”¾é­”æ³•ã€‚"}, extraLabel:"é­”æ³•æµæ´¾", 
            extraOptions:{
                soul:{name:"éˆé­‚æµæ´¾",desc:"æŒæ§éˆé­‚èˆ‡ç²¾ç¥ã€‚",addSkills:["éˆé­‚æµæ´¾","é«”æ“","é–ƒé¿","å¯Ÿè¦º","é†«ç™‚","èªè¨€","ç¥•èå‚³èªª","æ£æ£’"], mainSkill:"éˆé­‚æµæ´¾"}, 
                beast:{name:"ç¸è¡“æµæ´¾",desc:"é‡æ€§èˆ‡ç‹©çµä¹‹åŠ›ã€‚",addSkills:["ç¸è¡“æµæ´¾","é–ƒé¿","ç‹©çµ","éš±åŒ¿","é‡ç¸çŸ¥è­˜","æ±‚ç”Ÿ","æ£æ£’","å°åˆ€"], mainSkill:"ç¸è¡“æµæ´¾"}, 
                pluma:{name:"ç¾½è¡“æµæ´¾",desc:"ç”Ÿå‘½èˆ‡ä¿è­·ä¹‹åŠ›ã€‚",addSkills:["ç¾½è¡“æµæ´¾","é–ƒé¿","é«”æ“","éš±åŒ¿","é‡ç¸çŸ¥è­˜","æ±‚ç”Ÿ","é†«ç™‚","å¯Ÿè¦º"], mainSkill:"ç¾½è¡“æµæ´¾"}, 
                elem:{name:"å…ƒç´ æµæ´¾",desc:"æ“æ§å››å¤§å…ƒç´ ã€‚",addSkills:["å…ƒç´ æµæ´¾","é–ƒé¿","å¯Ÿè¦º","é†«ç™‚","èªè¨€","ç¥•èå‚³èªª","èª¿æŸ¥","æ£æ£’"], mainSkill:"å…ƒç´ æµæ´¾"}
            }, 
            gear: [{name:"1.æ°´æ™¶çƒ",items:["ç¡¬æœ¨æ£’","æ°´æ™¶çƒ","é­”å°æ›¸","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.é­”æ–",items:["å°åˆ€","é­”æ–","é­”å°æ›¸","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"3.è–å¾½",items:["è–å¾½","é­”å°æ›¸","ç¡è¢‹","ç«ç‚¬","æ‰“ç«åŒ£"]}] 
        },
        scholar: { name: "å­¸è€…", id: "scholar", attr: "INT", resource: "1D6 é£Ÿç‰©, 1D10 éŠ€å¹£", skills: ["é–ƒé¿", "å¯Ÿè¦º", "é‡ç¸çŸ¥è­˜", "æ±‚ç”Ÿ", "é†«ç™‚", "èªè¨€", "ç¥•èå‚³èªª", "èª¿æŸ¥"], heroAbilities: {a:"ã€ç›´è¦ºæ€è€ƒã€‘<span class='wp-cost'>WP: 3</span> è©¢å•GMç²æç¤ºã€‚",b:"ã€ç¾å ´æ•™å­¸ã€‘<span class='wp-cost'>WP: 3</span> å”åŠ©è¤‡æ•¸ç›Ÿå‹ã€‚",c:"ã€ç¶“é©—åˆ†äº«ã€‘å‚³æˆæŠ€èƒ½æˆé•·æ©Ÿæœƒã€‚"}, extraLabel:"è¡“æ¥­æœ‰å°ˆæ”»", extraOptions:{celest:{name:"å¤©å¾‹",desc:"æ”¹å¯«å¤±æ•—", extraSkill:"å¤©å¾‹å­¸"}, theo:{name:"ç¥å¾‹",desc:"é‡éª°", extraSkill:"ç¥å¾‹å­¸"}, num:{name:"æ•¸å¾‹",desc:"æ“ç¸±å…ˆæ”»", extraSkill:"æ•¸å¾‹å­¸"}, vita:{name:"ç”ŸçŸ¥",desc:"å¤±æ•—ç²å‡ç´šæ¨™è¨˜"}}, gear: [{name:"1.ç­†è¨˜",items:["ç¡¬æœ¨æ£’","ç­†è¨˜æœ¬","ç¾½æ¯›ç­†","ç¡è¢‹","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.æ›¸ç±",items:["é»‘æ›œçŸ³å°åˆ€","æ›¸æœ¬","ç¡è¢‹","æ²¹ç‡ˆ","ç‡ˆæ²¹","æ‰“ç«åŒ£"]},{name:"3.é†«ç™‚",items:["æŠ•çŸ³ç¹©","ç¹ƒå¸¶","å‚¬çœ æ¯’è—¥","ç¡è¢‹","æç‡ˆ","ç‡ˆæ²¹","æ‰“ç«åŒ£"]}] },
        thief: { name: "ç›œè³Š", id: "thief", attr: "AGL", resource: "1D6 é£Ÿç‰©, 1D10 éŠ€å¹£", skills: ["å·§æ‰‹","éš±åŒ¿","é«”æ“","é–ƒé¿","å¯Ÿè¦º","èª¿æŸ¥","æ¬ºç","å°åˆ€"], heroAbilities: {a:"ã€èƒŒåˆºã€‘<span class='wp-cost'>WP: 3</span> å·è¥²ç²å„ªå‹¢å¢å‚·ã€‚",b:"ã€è¿…æ·æ­¥æ³•ã€‘<span class='wp-cost'>WP: 3</span> åæ‡‰é–ƒé¿ã€‚",c:"ã€é–ƒé›»é€Ÿåº¦ã€‘<span class='wp-cost'>WP: 2</span> å…ˆæ”»äºŒé¸ä¸€ã€‚"}, gear: [{name:"1.çˆªé‰¤",items:["é»‘æ›œçŸ³å°åˆ€","æŠ•çŸ³ç¹©","é»‘æ›œçŸ³å½ˆä¸¸è¢‹","10ç±³éº»ç¹©","çˆªé‰¤","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.é–‹é–",items:["é»‘æ›œçŸ³å°åˆ€","ç°¡æ˜“é–‹é–å™¨","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"3.æ»¾ç ",items:["é»‘æ›œçŸ³å°åˆ€","å¹ç®­ç­’","å¹ç®­è¢‹","æ»¾ç ","ç«ç‚¬","æ‰“ç«åŒ£"]}] },
        pochteca: { name: "æ—…å•†", id: "pochteca", attr: "CHA", resource: "1D6 é£Ÿç‰©, 1D12 éŠ€å¹£", skills: ["äº¤æ˜“","éŠèªª","é–ƒé¿","é¨è¡“","å¯Ÿè¦º","èª¿æŸ¥","æ¬ºç","å°åˆ€"], heroAbilities: {a:"ã€å¯Ÿè¨€è§€è‰²ã€‘<span class='wp-cost'>WP: 3</span> åˆ¤æ–·æƒ…ç·’è¬Šè¨€ã€‚",b:"ã€å•†éšŠé ˜è¢–ã€‘<span class='wp-cost'>WP: 3</span> ç¸®çŸ­æ—…è¡Œæ™‚é–“ã€‚",c:"ã€æƒ…å ±æ®å®¢ã€‘<span class='wp-cost'>WP: 3</span> ç²å–æƒ…å ±ã€‚"}, gear: [{name:"1.é‡ç‚Š",items:["é»‘æ›œçŸ³å°åˆ€","é‡ç‚Šå·¥å…·","é¦¬è»Š","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.æç‡ˆ",items:["é»‘æ›œçŸ³å°åˆ€","æç‡ˆ","é¦¬è»Š","ç‡ˆæ²¹","æ‰“ç«åŒ£"]}] },
        farmer: { name: "è¾²æ°‘", id: "farmer", attr: "INT", resource: "1D8 é£Ÿç‰©, 1D10 éŠ€å¹£", skills: ["æ±‚ç”Ÿ","å·¥è—","ç‹©çµ","é‡ç¸çŸ¥è­˜","å¯Ÿè¦º","æ¸¸æ³³","èª¿æŸ¥","å¾’æ‰‹"], heroAbilities: {a:"ã€æµ®ç”°è€•è—ã€‘ç¨®æ¤æµ®ç”°(ç¿’å¾—æµ®ç”°è¡“)ã€‚",b:"ã€æ°´çµå·§æŠ€ã€‘<span class='wp-cost'>WP: 2</span> æ°´ä¸­å„ªå‹¢ã€‚",c:"ã€å¤§å»šã€‘çƒ¹é£ªç¾é£Ÿã€‚", extraSkill:"å»šè—"}, gear: [{name:"1.æ§Œå­",items:["æ§Œå­","é‡ç‚Šå·¥å…·","ç«ç‚¬","æ‰“ç«åŒ£"]},{name:"2.é¬",items:["åå­—é¬","ç¡è¢‹","æ²¹ç‡ˆ","ç‡ˆæ²¹","æ‰“ç«åŒ£"]},{name:"3.éŸå­",items:["éŸå­","é‡£ç«¿","ç«ç‚¬","æ‰“ç«åŒ£"]}] }
    };

    const ALL_SKILLS = ["å·¥è—", "å·§æ‰‹", "èª¿æŸ¥", "å¾’æ‰‹", "æ–§", "æ£æ£’", "åŠ", "å°åˆ€", "å¼“", "æŠ•æ§å™¨", "æŠ•çŸ³ç¹©", "å¹ç®­ç­’", "çŸ›", "é«”æ“", "ç‹©çµ", "éš±åŒ¿", "å¯Ÿè¦º", "æ±‚ç”Ÿ", "é¨è¡“", "æ¸¸æ³³", "é†«ç™‚", "èªè¨€", "ç¥•èå‚³èªª", "èˆ¹è—", "äº¤æ˜“", "æ¬ºç", "è¡¨æ¼”", "éŠèªª", "é‡ç¸çŸ¥è­˜", "éˆé­‚æµæ´¾", "ç¸è¡“æµæ´¾", "ç¾½è¡“æµæ´¾", "å…ƒç´ æµæ´¾", "å¤©å¾‹å­¸", "ç¥å¾‹å­¸", "æ•¸å¾‹å­¸", "å»šè—", "åº«æ‹‰é‡Œ"];
    
    // ä¿®æ­£ï¼šé–ƒé¿å°æ‡‰ AGL
    const SKILL_ATTR_MAP = {
        "å·¥è—": "STR", "å·§æ‰‹": "AGL", "èª¿æŸ¥": "INT", "å¾’æ‰‹": "STR", "æ–§": "STR", "æ£æ£’": "STR", "åŠ": "STR", "å°åˆ€": "AGL",
        "å¼“": "AGL", "æŠ•æ§å™¨": "STR", "æŠ•çŸ³ç¹©": "AGL", "å¹ç®­ç­’": "AGL", "çŸ›": "STR", "é«”æ“": "AGL", "ç‹©çµ": "AGL", "éš±åŒ¿": "AGL",
        "å¯Ÿè¦º": "INT", "æ±‚ç”Ÿ": "INT", "é¨è¡“": "AGL", "æ¸¸æ³³": "AGL", "é†«ç™‚": "INT", "èªè¨€": "INT", "ç¥•èå‚³èªª": "INT", "èˆ¹è—": "INT",
        "äº¤æ˜“": "CHA", "æ¬ºç": "CHA", "è¡¨æ¼”": "CHA", "éŠèªª": "CHA", "é‡ç¸çŸ¥è­˜": "INT", "é–ƒé¿": "AGL",
        "éˆé­‚æµæ´¾": "INT", "ç¸è¡“æµæ´¾": "INT", "ç¾½è¡“æµæ´¾": "INT", "å…ƒç´ æµæ´¾": "INT", 
        "å¤©å¾‹å­¸": "INT", "ç¥å¾‹å­¸": "INT", "æ•¸å¾‹å­¸": "INT", "å»šè—": "INT", "åº«æ‹‰é‡Œ": "INT"
    };

    const MEMENTOS = ["ä¸€é›™èˆ’é©è€ç©¿çš„èˆŠé‹å­", "ä¸€é¢æ¨¸ç´ çš„éŠ€è£½çç« ", "ä¸€å°ä¾†è‡ªè€å‹æˆ–è¦ªæˆšçš„ä¿¡", "ä¸€æœ¬ç ´çˆ›çš„èˆŠæ—¥è¨˜æœ¬", "ä¸€å€‹ä½ å®¶æ—ä»£ä»£ç›¸å‚³çš„æ‰‹é²", "ä¸€å°Šä½ ç«¥å¹´æ™‚ç²å¾—çš„æœ¨é›•åƒ", "ä¸€é¡†å½¢ç‹€æ€ªç•°çš„çŸ³é ­", "çˆ¶æ¯é€ä½ çš„ä¸€æšç´€å¿µéŠ…å¹£", "ä¸€å€‹è€èˆŠçš„éŒ«è£½é…’æ¯", "ä½œç‚ºæˆ°åˆ©å“çš„æ€ªç‰©çŠ„è§’", "å¹¾é¡†éª¨è£½éª°å­", "ç¹«è‘—ä¸€å°æŸé ­é«®çš„åŠå¢œç›’", "ä¸€æŠŠè¯éº—çš„é‘°åŒ™", "ä¸€å¼µä½ ç¹¼æ‰¿çš„æ‰‹ç¹ªåœ°åœ–", "ä¸€åªåˆ»æœ‰éŠ˜æ–‡çš„æˆ’æŒ‡", "ä¸€å€‹éª¨è£½å“¨å­", "é ‚ä½ çˆ¶æ¯çš„èˆŠå¸½å­", "æ ¼é‡ŒèŠ¬çš„ä¸€æ ¹ç¾½æ¯›", "ä¸€æ ¹é›•å¡‘ç²¾ç¾çš„ç…™æ–—"];
    const WEAKNESSES = ["è¼•ä¿¡ï¼šæˆ‘ç›¸ä¿¡åˆ¥äººå‘Šè¨´æˆ‘çš„ä¸€åˆ‡ã€‚", "è²ªå©ªï¼šæˆ‘æƒ³è¦æ›´å¤šçš„è²¡å¯Œã€‚", "è‡‰çš®è–„ï¼šæˆ‘çµ•ä¸å®¹å¿è¢«æŒ‘é‡ã€‚", "è½æ’ï¼šæˆ‘ç¸½æ˜¯ç¬¬ä¸€å€‹è¡å…¥å±éšªã€‚", "æ‡¦å¼±ï¼šæˆ‘ç¸½æ˜¯å¾…åœ¨éšŠä¼çš„æœ€å¾Œé¢ã€‚", "æ€ªç‰©æ®ºæ‰‹ï¼šæ‰€æœ‰æ€ªç‰©éƒ½æ˜¯é‚ªæƒ¡çš„ï¼Œå¿…é ˆæ®ºæ‰ã€‚", "æ†æ¨ï¼šè°æ‰‹ç¸çš†è©²è¢«å‰·é™¤ã€‚", "æ‡¶æƒ°ï¼šæˆ‘ä¸€æŠ“åˆ°æ©Ÿæœƒå°±æƒ³ä¼‘æ¯ã€‚", "	è²ªåƒï¼šæˆ‘æœƒæŠŠæ¡åƒåˆ°ç¾é£Ÿçš„æ‰€æœ‰æ©Ÿæœƒã€‚", "è™›æ¦®ï¼šæˆ‘æœƒå¹«åŠ©ä»»ä½•ç¨±è®šæˆ‘çš„äººã€‚", "é­¯è½ï¼šæˆ‘ç¸½æ˜¯ä¸è€ƒæ…®å¾Œæœåœ°å†’éšªã€‚", "ç«Šç›œç™–ï¼šæˆ‘çœ‹åˆ°è²´é‡ç‰©å“å°±æ‰‹ç™¢æƒ³å·ã€‚", "å®³æ€•é­”æ³•ï¼šé­”æ³•æ˜¯é‚ªæƒ¡çš„åŠ›é‡ï¼Œä¸èƒ½ç›¸ä¿¡è–©æ»¿ã€‚", "æ¸´æ±‚çŸ¥è­˜ï¼šçŸ¥è­˜æ¯”æœ‹å‹æ›´é‡è¦ã€‚", "è’é‡ä¹‹å­ï¼šæˆ‘å¾ä¸åœ¨å®¤å…§ç¡è¦ºã€‚", "å¹ç‰›ï¼šæˆ‘ç¸½æ˜¯èª‡å¤§æˆ‘çš„æˆå°±ã€‚", "æš´åŠ›ï¼šæˆ‘è¨´è«¸æš´åŠ›ä¾†å…‹æœæ¯ä¸€å€‹éšœç¤™ã€‚", "éœ¸é“ï¼šæˆ‘ç¸½æ˜¯å‘½ä»¤åˆ¥äººè©²æ€éº¼åšã€‚", "æ‚²è§€ï¼šæˆ‘ç¸½æ˜¯èªç‚ºäº‹æƒ…æœƒå¾€æœ€å£æ–¹å‘ç™¼å±•ã€‚", "å‚²æ…¢ï¼šæˆ‘çœ‹ä¸èµ·æ‰€æœ‰äººã€‚"];
    const APPEARANCES = ["è‡‰é °ä¸Šæœ‰ä¸€é“é›£çœ‹çš„ç–¤ç—•", "æˆ´è‘—å¥‡æ€ªçš„é ­é£¾", "çš®è†šç•°å¸¸è’¼ç™½", "è‡‰ä¸Šç¸½æ˜¯æ›è‘—å¾®ç¬‘", "çœ¼ç¥å†°å†·ä¸”éŠ³åˆ©", "è‚šå­æœ‰ä¸€åœˆè´…è‚‰", "æ¶ˆç˜¦ä½†ç²¾å¯¦", "é«”æ¯›ç•°å¸¸åœ°å¤š", "ç¦¿é ­", "é¡¯çœ¼çš„ç´‹èº«", "é›£èçš„é«”å‘³", "è¯éº—çš„é«®å‹", "èµ°è·¯ä¸€è·›ä¸€è·›", "éª¯é«’æ²’æ´—æ¾¡", "èª å¯¦çš„è—è‰²çœ¼ç›", "ä¸€é¡†éŠ€è£½å‡ç‰™", "æ¿ƒé‡çš„é¦™æ°´å‘³", "ç•°è‰²ç³", "è²éŸ³æ²™å•", "é£½ç¶“é¢¨éœœçš„çšºç´‹"];
    const SPELLS = {
        gen: ["äº®","å–","å½ˆ","é–‹/é—œ","ç¸«è£œ","æ„Ÿæ‡‰é­”æ³•","ä¸Šé–/é–‹é–","æ¸…ç†","çƒ¹é£ª","ç†é«®","é­”æ³•å‡³","è§£æ¶ˆè¡“","é˜²è­·è¡“"],
        soul: ["æ„Ÿæ‡‰éˆé­‚","å¥‡è¡“","å®‰å®šéˆé­‚","æ”¾é€è¡“","ç™‚å‚·è¡“","éˆé­‚ä¹‹æ¥”","éˆé­‚ä½èª","é™è¦–è¡“"],
        beast: ["ä¼æ“Š","é‡ç¸æ„Ÿå®˜","æ„Ÿæ‡‰å¿ƒè·³","è›‡è‡‚è¡“","å™´å°„éŠ³çŸ³","æ¯’åˆƒè¡“","é‡ç¸ä½èª","çµè€…ä¹‹ä»¤","çˆªåˆƒè¡“","ç¸ç”²å¼·åŒ–","å¤§æ­¥å¥”è¡Œ"],
        pluma: ["èŠ±å¾‘","é³¥èª","æ„Ÿæ‡‰æ°£æ¯","ç¾½è½","é›»å…‰ä¸€é–ƒ","çºç¹ä¹‹æ ¹","å‹•ç‰©ä½èª","æ¼‚æµ®è¡“","é£›ç¾½é¢","ç¶»æ”¾è¡“","å¤¸çˆ¾ç‰¹ä¹‹æ¯"],
        elem: ["å‡æº«/å†·å»","ç…™åœ˜","é»ç‡ƒ","ç«çƒè¡“","çŸ³æŸ±è¡“","ç¢è£‚è¡“","å¼·é¢¨è¡“","å¯’éœœè¡“"]
    };

    /* ================= ç‹€æ…‹ ================= */
    let char = {
        race: 'human', subrace: 'maztican', age: 'adult',
        prof: 'warrior', heroKey: null, extraKey: null, gearIndex: 0, weaponChoice: null,
        attrs: {STR:10, CON:10, AGL:10, INT:10, WIL:10, CHA:10},
        calculatedAttrs: {STR:10, CON:10, AGL:10, INT:10, WIL:10, CHA:10},
        coreSkills: [], freeSkills: [], bonusSkills: [], // æ–°å¢ï¼šé¡å¤–è´ˆé€æŠ€èƒ½
        spells: { t0:[], t1:[] }
    };

    /* ================= æ•¸å­¸å…¬å¼ ================= */
    function getSkillBase(attrVal) {
        if(attrVal <= 5) return 3;
        if(attrVal <= 8) return 4;
        if(attrVal <= 12) return 5;
        if(attrVal <= 15) return 6;
        return 7;
    }

    function getDmgBonus(attrVal) {
        if(attrVal <= 12) return "-";
        if(attrVal <= 16) return "+1D4";
        return "+1D6";
    }

    /* ================= è¼ªç›¤é‚è¼¯ ================= */
    let outerAngle = 0; let innerAngle = 0;
    const raceKeys = Object.keys(RACES);
    const classKeys = Object.keys(PROFESSIONS);

    function getIconPath(id) { return `images/icon_${id}.webp`; }

    function initWheel() {
        const classRing = document.getElementById('class-ring');
        const raceRing = document.getElementById('race-ring');
        
        createRingItems(classRing, classKeys, PROFESSIONS, 220, 'outer', (index) => {
            rotateToItem('outer', index, classKeys.length);
            char.prof = classKeys[index];
            // è·æ¥­æ›´æ›æ™‚çš„æ¸…ç†é‚è¼¯
            char.heroKey = null; char.extraKey = null; 
            char.coreSkills = []; // æ¸…ç©ºæ ¸å¿ƒæŠ€èƒ½
            char.bonusSkills = []; // æ¸…ç©ºè´ˆé€æŠ€èƒ½
            updateClassOptions();
            updateLabelDisplay();
            updateAvatar(); // é»æ“Šæ™‚ç¢ºä¿æ›´æ–°ç«‹ç¹ª
        });

        createRingItems(raceRing, raceKeys, RACES, 132, 'inner', (index) => {
            rotateToItem('inner', index, raceKeys.length);
            char.race = raceKeys[index];
            updateRaceOptions();
            updateLabelDisplay();
            updateAvatar(); // é»æ“Šæ™‚ç¢ºä¿æ›´æ–°ç«‹ç¹ª
        });

        updateActiveItem('class-ring', 0);
        updateActiveItem('race-ring', 0);
        updateLabelDisplay();
    }

    function createRingItems(ring, keys, dataObj, radius, type, callback) {
        const step = 360 / keys.length;
        ring.innerHTML = "";
        keys.forEach((key, i) => {
            const itemData = dataObj[key];
            const el = document.createElement('div');
            el.className = 'wheel-item';
            el.innerHTML = `<img src="${getIconPath(key)}" alt="${itemData.name}" onerror="this.style.display='none';this.parentNode.innerText='${itemData.name[0]}'">`;
            const angle = i * step - 90;
            el.style.transform = `rotate(${angle}deg) translate(${radius}px) rotate(${-angle}deg)`;
            el.onclick = () => callback(i);
            el.onmouseenter = () => updateLabelHover(type, itemData.name);
            el.onmouseleave = () => updateLabelDisplay();
            ring.appendChild(el);
        });
    }

    function rotateToItem(type, index, total) {
        const step = 360 / total;
        const targetAngle = -(index * step);
        let currentAngle = (type === 'outer') ? outerAngle : innerAngle;
        let delta = targetAngle - (currentAngle % 360);
        if (delta > 180) delta -= 360; else if (delta < -180) delta += 360;
        const finalAngle = currentAngle + delta;
        const ringId = (type === 'outer') ? 'class-ring' : 'race-ring';
        const radius = (type === 'outer') ? 220 : 132;
        const ringEl = document.getElementById(ringId);
        
        if (type === 'outer') outerAngle = finalAngle; else innerAngle = finalAngle;
        ringEl.style.transform = `rotate(${finalAngle}deg)`;
        
        updateItemRotation(ringEl, finalAngle, radius, total);
        updateActiveItem(ringId, index);
    }

    function updateItemRotation(ring, ringRotation, radius, total) {
        const items = ring.querySelectorAll('.wheel-item');
        const step = 360 / total;
        items.forEach((item, i) => {
            const itemBaseAngle = i * step - 90;
            item.style.transform = `rotate(${itemBaseAngle}deg) translate(${radius}px) rotate(${-itemBaseAngle - ringRotation}deg)`;
        });
    }

    function updateActiveItem(ringId, activeIndex) {
        const items = document.querySelectorAll(`#${ringId} .wheel-item`);
        items.forEach((item, i) => {
            if (i === activeIndex) item.classList.add('active'); else item.classList.remove('active');
        });
    }

    // --- æ·¡å…¥æ·¡å‡ºèˆ‡é åŠ è¼‰ ---
    let currentAvatarRequest = 0; 

    function updateAvatar() {
        const rData = RACES[char.race];
        const pData = PROFESSIONS[char.prof];
        const img = document.getElementById('char-img');
        
        let targetSrc = `images/${rData.id}_${pData.id}.webp`;
        if (rData.subraces && char.subrace) {
            const subId = rData.subraces[char.subrace].id;
            targetSrc = `images/${rData.id}_${subId}_${pData.id}.webp`;
        }

        const requestId = ++currentAvatarRequest;
        img.style.opacity = 0;

        const tryLoad = (src) => {
            return new Promise((resolve, reject) => {
                const temp = new Image();
                temp.onload = () => resolve(src);
                temp.onerror = () => reject();
                temp.src = src;
            });
        };

        setTimeout(async () => {
            if (requestId !== currentAvatarRequest) return; 

            try {
                await tryLoad(targetSrc);
                if (requestId !== currentAvatarRequest) return;
                img.src = targetSrc;
            } catch (e) {
                try {
                    const fallbackSrc = `images/${rData.id}_${pData.id}.webp`;
                    if (targetSrc === fallbackSrc) throw "No fallback"; 
                    await tryLoad(fallbackSrc);
                    if (requestId !== currentAvatarRequest) return;
                    img.src = fallbackSrc;
                } catch (e2) {
                    if (requestId !== currentAvatarRequest) return;
                    img.src = `https://placehold.co/600x600/333/gold?text=${rData.name}`;
                }
            }
            
            img.style.opacity = 1;
        }, 300);
    }

    function updateLabelDisplay() {
        const rName = RACES[char.race].name.split(' ')[0];
        const cName = PROFESSIONS[char.prof].name.split(' ')[0];
        document.getElementById('race-label-display').innerText = rName;
        document.getElementById('class-label-display').innerText = cName;
        // åˆ†é›¢é‚è¼¯ï¼šé€™è£¡ä¸å†å‘¼å« updateAvatar
    }

    function updateLabelHover(type, name) {
        const simpleName = name.split(' ')[0];
        if(type==='inner') document.getElementById('race-label-display').innerText = simpleName;
        else document.getElementById('class-label-display').innerText = simpleName;
    }

    // --- éš¨æ©ŸåŠŸèƒ½ ---
    function randomizeRace() {
        const idx = Math.floor(Math.random() * raceKeys.length);
        rotateToItem('inner', idx, raceKeys.length);
        char.race = raceKeys[idx];
        updateRaceOptions();
        updateLabelDisplay();
        updateAvatar(); // æ˜ç¢ºå‘¼å«
    }

    function randomizeClass() {
        const idx = Math.floor(Math.random() * classKeys.length);
        rotateToItem('outer', idx, classKeys.length);
        char.prof = classKeys[idx];
        char.bonusSkills = []; // æ¸…ç†è´ˆé€æŠ€èƒ½
        updateClassOptions();
        updateLabelDisplay();
        updateAvatar(); // æ˜ç¢ºå‘¼å«
    }

    function randomizeTrait(type) {
        let list = [];
        if(type==='weakness') list = WEAKNESSES;
        else if(type==='appearance') list = APPEARANCES;
        else if(type==='memento') list = MEMENTOS;
        
        const val = list[Math.floor(Math.random() * list.length)];
        document.getElementById(`${type}-select`).value = val;
        handleCustomInput(type);
    }

    /* ================= UI æ›´æ–°é‚è¼¯ ================= */
    function init() {
        const attrDiv = document.getElementById('attr-inputs');
        for(let k in char.attrs) {
            attrDiv.innerHTML += `
                <div class="attr-row">
                    <span style="font-size:0.9em; color:#bbb; font-weight:bold;">${k}</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="number" id="base-${k}" value="10" min="3" max="18" class="stat-input" onchange="updateStatsAndSkills()">
                        <span style="color:#666;">â–º</span>
                        <span id="final-${k}" class="final-val">10</span>
                    </div>
                </div>`;
        }

        fillSimpleSelect('memento-select', MEMENTOS, "éš¨æ©Ÿ / è‡ªé¸");
        fillSimpleSelect('weakness-select', WEAKNESSES, "éš¨æ©Ÿ / è‡ªé¸");
        fillSimpleSelect('appearance-select', APPEARANCES, "éš¨æ©Ÿ / è‡ªé¸");

        initWheel();
        updateRaceOptions();
        updateClassOptions();
    }

    function fillSimpleSelect(id, list, defaultTxt) {
        const el = document.getElementById(id);
        el.add(new Option(defaultTxt, "random"));
        list.forEach(i => el.add(new Option(i, i)));
        el.add(new Option("ã€è‡ªè¨‚...ã€‘", "custom"));
    }

    function updateRaceOptions() {
        const rData = RACES[char.race];
        const subSel = document.getElementById('subrace-select');
        const subDiv = document.getElementById('subrace-container');
        subSel.innerHTML = "";
        
        if(rData.subraces) {
            subDiv.style.display = 'block';
            for(let k in rData.subraces) subSel.add(new Option(rData.subraces[k].name, k));
            char.subrace = subSel.value;
        } else {
            subDiv.style.display = 'none';
            char.subrace = null;
        }
        updateRaceAbility();
    }

    function updateRaceAbility() {
        char.subrace = document.getElementById('subrace-select').value;
        const rData = RACES[char.race];
        let text = rData.ability;
        if(char.subrace && rData.subraces && rData.subraces[char.subrace]) {
            text += `<br><br><span class="highlight">äºç¨®ç‰¹æ€§:</span> ` + rData.subraces[char.subrace].ability;
        }
        document.getElementById('race-ability-box').innerHTML = text;
        
        // è§¸ç™¼å…¨å±€æŠ€èƒ½é‡ç®—
        updateBonusSkills();
        updateStatsAndSkills();
        updateAvatar();
    }

    function updateClassOptions() {
        const pData = PROFESSIONS[char.prof];
        
        document.getElementById('resource-hint').innerText = `èµ·å§‹è³‡æº: ${pData.resource}`;

        const heroDiv = document.getElementById('hero-ability-container');
        const heroSel = document.getElementById('hero-ability-select');
        heroSel.innerHTML = "";
        if(pData.heroAbilities) {
            heroDiv.style.display = 'block';
            for(let k in pData.heroAbilities) heroSel.add(new Option(pData.heroAbilities[k].split('ã€‘')[0]+'ã€‘', k));
        } else { heroDiv.style.display = 'none'; char.heroKey = null; }

        const extraDiv = document.getElementById('extra-trait-container');
        const extraSel = document.getElementById('extra-trait-select');
        extraSel.innerHTML = "";
        if(pData.extraOptions) {
            extraDiv.style.display = 'block';
            document.getElementById('extra-trait-label').innerText = pData.extraLabel.toUpperCase();
            for(let k in pData.extraOptions) extraSel.add(new Option(pData.extraOptions[k].name, k));
        } else { extraDiv.style.display = 'none'; char.extraKey = null; }

        const eqSel = document.getElementById('equip-select');
        eqSel.innerHTML = "";
        pData.gear.forEach((g,i) => eqSel.add(new Option(g.name, i)));

        updateHeroDesc();
    }

    function updateHeroDesc() {
        const pData = PROFESSIONS[char.prof];
        if (pData.heroAbilities) {
            char.heroKey = document.getElementById('hero-ability-select').value;
            document.getElementById('hero-desc').innerHTML = pData.heroAbilities[char.heroKey];
        }
        updateExtraTrait();
    }

    function updateExtraTrait() {
        const pData = PROFESSIONS[char.prof];
        if (pData.extraOptions) {
            char.extraKey = document.getElementById('extra-trait-select').value;
            const opt = pData.extraOptions[char.extraKey];
            document.getElementById('extra-desc').innerHTML = opt.desc;
        }
        
        const spellSel = document.getElementById('spell-selector');
        if (char.prof === 'shaman') {
            spellSel.style.display = 'block';
            char.spells = {t0:[], t1:[]};
            renderSpellButtons();
        } else { spellSel.style.display = 'none'; }
        
        // è§¸ç™¼å…¨å±€æŠ€èƒ½é‡ç®—
        updateBonusSkills();
        renderCoreSkills();
        updateInventory(); 
    }

    // --- æ–°å¢ï¼šå…¨å±€è´ˆé€æŠ€èƒ½é‡ç®—å‡½å¼ ---
    function updateBonusSkills() {
        char.bonusSkills = [];
        const rData = RACES[char.race];
        const pData = PROFESSIONS[char.prof];

        // 1. æ—è£”è´ˆé€
        if(char.race === 'halfling') {
            char.bonusSkills.push(rData.extraSkill);
        }

        // 2. è·æ¥­/èƒ½åŠ›è´ˆé€
        if(char.prof === 'farmer' && char.heroKey && pData.heroAbilities[char.heroKey].includes("å¤§å»š")) {
            char.bonusSkills.push("å»šè—");
        }
        if(char.prof === 'scholar' && char.extraKey && pData.extraOptions[char.extraKey].extraSkill) {
            char.bonusSkills.push(pData.extraOptions[char.extraKey].extraSkill);
        }

        renderFreeSkills(); // æ›´æ–°UI
    }

    function renderCoreSkills() {
        const pData = PROFESSIONS[char.prof];
        let pool = [...pData.skills];
        let mandatorySkill = null; 

        // è–©æ»¿å¼·åˆ¶æŠ€èƒ½é‚è¼¯
        if(char.prof === 'shaman' && char.extraKey) {
            const exOpt = pData.extraOptions[char.extraKey];
            // [é—œéµä¿®æ­£] å¼·åˆ¶å°‡ä¸»æŠ€èƒ½åŠ å…¥æ¸…å–®
            pool = [exOpt.mainSkill, ...exOpt.addSkills]; 
            // å»é™¤é‡è¤‡
            pool = [...new Set(pool)];
            mandatorySkill = exOpt.mainSkill;
            
            // ç¢ºä¿å¼·åˆ¶æŠ€èƒ½åœ¨æ ¸å¿ƒæŠ€èƒ½ä¸­
            if(!char.coreSkills.includes(mandatorySkill)) {
                // å¦‚æœå·²ç¶“æ»¿6å€‹ï¼Œå˜—è©¦ç§»é™¤ä¸€å€‹éå¼·åˆ¶çš„
                if(char.coreSkills.length >= 6) {
                     char.coreSkills.pop();
                }
                char.coreSkills.push(mandatorySkill);
            }
        }
        else if((char.prof==='knight'||char.prof==='scholar'||char.prof==='farmer') && char.extraKey && pData.extraOptions[char.extraKey].addSkills) {
             pool = [...new Set([...pool, ...pData.extraOptions[char.extraKey].addSkills])];
        }
        
        // æ¸…ç†ç„¡æ•ˆçš„æ ¸å¿ƒæŠ€èƒ½ (åˆ‡æ›è·æ¥­æˆ–è–©æ»¿æµæ´¾æ™‚)
        char.coreSkills = char.coreSkills.filter(s => pool.includes(s));

        const div = document.getElementById('core-skill-list');
        div.innerHTML = "";
        
        pool.forEach(s => {
            const btn = document.createElement('div');
            btn.className = 'skill-check';
            const attrKey = SKILL_ATTR_MAP[s] || "STR";
            const attrVal = char.calculatedAttrs[attrKey] || 10;
            const baseVal = getSkillBase(attrVal);
            
            let currentVal = baseVal;
            let isLocked = (s === mandatorySkill); // åˆ¤æ–·æ˜¯å¦ç‚ºå¼·åˆ¶é–å®š

            if (char.coreSkills.includes(s)) {
                btn.classList.add('active');
                currentVal = baseVal * 2;
            }
            if (isLocked) {
                btn.classList.add('locked');
            }
            
            btn.innerHTML = `<span>${s}</span><span class="skill-val" id="skill-val-${s}">${currentVal}</span>`;
            
            btn.onclick = () => {
                if(isLocked) return; // é–å®šä¸å¯å–æ¶ˆ

                const valSpan = btn.querySelector('.skill-val');
                const isTrained = btn.classList.contains('active');
                
                if(isTrained) {
                    char.coreSkills = char.coreSkills.filter(x=>x!==s);
                    btn.classList.remove('active');
                    valSpan.innerText = baseVal;
                } else {
                    if(char.coreSkills.length>=6) { alert("æ ¸å¿ƒæŠ€èƒ½æœ€å¤šé¸ 6 é …ï¼"); return; }
                    char.coreSkills.push(s);
                    btn.classList.add('active');
                    valSpan.innerText = baseVal * 2;
                }
                updateFreeSkillOptions();
            };
            div.appendChild(btn);
        });
        updateFreeSkillOptions();
    }

    function updateFreeSkillOptions() {
        const sel = document.getElementById('free-skill-select');
        sel.innerHTML = "";
        const allTrainedSkills = [...char.coreSkills, ...char.freeSkills, ...char.bonusSkills];
        const availableSkills = ALL_SKILLS.filter(s => !allTrainedSkills.includes(s));
        availableSkills.forEach(s => {
            sel.add(new Option(s, s));
        });
    }

    function addFreeSkill() {
        let max = char.age==='young'?2:(char.age==='old'?6:4);
        if(char.freeSkills.length>=max) { alert(`ä½ æœ€å¤šåªèƒ½é¸æ“‡ ${max} å€‹è‡ªç”±å—è¨“æŠ€èƒ½ï¼`); return; }
        const s = document.getElementById('free-skill-select').value;
        if(!s) return;
        
        char.freeSkills.push(s);
        renderFreeSkills();
        updateFreeSkillOptions(); 
    }
    
    function renderFreeSkills() {
        const div = document.getElementById('free-skill-list');
        // æ¸²æŸ“è‡ªç”±æŠ€èƒ½
        let html = char.freeSkills.map((s,i) => {
            const attrKey = SKILL_ATTR_MAP[s] || "STR";
            const attrVal = char.calculatedAttrs[attrKey] || 10;
            const baseVal = getSkillBase(attrVal);
            return `<span class="tag removable" onclick="char.freeSkills.splice(${i},1);renderFreeSkills();updateFreeSkillOptions()">${s} (${baseVal*2}) Ã—</span>`;
        }).join('');

        // æ¸²æŸ“é¡å¤–æŠ€èƒ½ (Bonus)
        char.bonusSkills.forEach(s => {
            const attrKey = SKILL_ATTR_MAP[s] || "STR";
            const attrVal = char.calculatedAttrs[attrKey] || 10;
            const baseVal = getSkillBase(attrVal);
            html += `<span class="tag bonus">${s} (${baseVal*2}) [å¤©è³¦]</span>`;
        });

        div.innerHTML = html;
        let max = char.age==='young'?2:(char.age==='old'?6:4);
        document.getElementById('skill-pts').innerText = `è‡ªç”±é»æ•¸: ${max - char.freeSkills.length}/${max}`;
    }

    function updateInventory() {
        char.gearIndex = document.getElementById('equip-select').value;
        const pData = PROFESSIONS[char.prof];
        
        // è™•ç†è£å‚™é¸æ“‡
        const gearSet = pData.gear[char.gearIndex];
        const weaponSelectDiv = document.getElementById('weapon-choice-container');
        const weaponSelect = document.getElementById('weapon-select');
        
        if(gearSet.choices) {
            weaponSelectDiv.style.display = 'block';
            if(char.weaponChoice === null || !gearSet.choices.includes(char.weaponChoice)) {
                weaponSelect.innerHTML = "";
                gearSet.choices.forEach(c => weaponSelect.add(new Option(c, c)));
                char.weaponChoice = weaponSelect.value;
            } else {
                const current = weaponSelect.value;
                weaponSelect.innerHTML = "";
                gearSet.choices.forEach(c => weaponSelect.add(new Option(c, c)));
                weaponSelect.value = current;
                char.weaponChoice = current;
            }
            weaponSelect.onchange = () => { char.weaponChoice = weaponSelect.value; updateInventory(); };
        } else {
            weaponSelectDiv.style.display = 'none';
            char.weaponChoice = null;
        }

        let items = [...gearSet.items];
        if(char.weaponChoice) items.unshift(char.weaponChoice); 

        if(char.prof === 'knight' && char.extraKey) {
            const orderName = PROFESSIONS.knight.extraOptions[char.extraKey].name.replace('åœ˜','');
            items = items.map(i => i.replace("é¨å£«æˆ°ç”²", orderName+"æˆ°ç”²"));
        }

        const memInput = document.getElementById('memento-custom');
        const memVal = memInput.style.display==='none' ? document.getElementById('memento-select').value : memInput.value;
        if(memVal && memVal!=='random' && memVal!=='custom') items.push("â˜… "+memVal);

        document.getElementById('inventory-list').innerHTML = items.map(i=>`<div class="tag item">${i}</div>`).join('');
    }

    // --- [æ ¸å¿ƒ] å±¬æ€§è¨ˆç®—èˆ‡é€£å‹• ---
    function updateStatsAndSkills() {
        char.age = document.getElementById('age-select').value;
        let final = {};
        
        for(let k in char.attrs) final[k] = parseInt(document.getElementById(`base-${k}`).value) || 10;
        
        if(char.race==='human' && char.subrace && RACES.human.subraces[char.subrace]) {
            let bonus = RACES.human.subraces[char.subrace].bonus;
            for(let k in bonus) final[k] += bonus[k];
        }
        
        if(char.age==='young') { final.AGL+=1; final.CON+=1; }
        if(char.age==='old') { final.STR-=2; final.AGL-=2; final.CON-=2; final.INT+=1; final.WIL+=1; }

        for(let k in final) {
            if(final[k]>18) final[k]=18; if(final[k]<3) final[k]=3;
            char.calculatedAttrs[k] = final[k];
            
            const el = document.getElementById(`final-${k}`);
            el.innerText = final[k];
            el.className = "final-val";
            let base = parseInt(document.getElementById(`base-${k}`).value);
            if(final[k]>base) el.classList.add('bonus');
            if(final[k]<base) el.classList.add('malus');
        }

        document.getElementById('val-hp').innerText = final.CON;
        document.getElementById('val-wp').innerText = final.WIL;
        document.getElementById('val-enc').innerText = Math.ceil(final.STR/2);
        
        const strBonus = getDmgBonus(final.STR);
        const aglBonus = getDmgBonus(final.AGL);
        document.getElementById('val-dmg').innerText = `${strBonus} / ${aglBonus}`;
        
        let move = RACES[char.race].baseMove;
        if(final.AGL <= 6) move -= 4; else if(final.AGL <= 9) move -= 2; else if(final.AGL >= 16) move += 4; else if(final.AGL >= 13) move += 2;
        document.getElementById('val-move').innerText = move;
        
        // é‡æ–°æ¸²æŸ“æ‰€æœ‰æŠ€èƒ½æ•¸å€¼
        renderCoreSkills(); 
        updateBonusSkills(); // é‡ç®—è´ˆé€æŠ€èƒ½
    }

    function updateAgeLogic() {
        char.age = document.getElementById('age-select').value;
        let max = char.age==='young'?2:(char.age==='old'?6:4);
        if(char.freeSkills.length > max) char.freeSkills = char.freeSkills.slice(0,max);
        updateStatsAndSkills(); 
    }

    function handleCustomInput(type) {
        const sel = document.getElementById(type+'-select');
        const input = document.getElementById(type+'-custom');
        if(sel.value==='custom') { input.style.display='block'; input.value=''; input.focus(); }
        else if(sel.value==='random') { input.style.display='none'; }
        else { input.style.display='none'; input.value=sel.value; }
        if(type==='memento') updateInventory();
    }

    function renderSpellButtons() {
        const flow = char.extraKey; if(!flow) return;
        const poolT0 = [...SPELLS.gen.slice(0,11), ...(SPELLS[flow] ? SPELLS[flow].slice(0, 3) : [])]; 
        const poolT1 = [...SPELLS.gen.slice(11), ...(SPELLS[flow] ? SPELLS[flow].slice(3) : [])];
        renderGrid('grid-t0', poolT0, 't0');
        renderGrid('grid-t1', poolT1, 't1');
    }

    function renderGrid(id, list, tier) {
        const div = document.getElementById(id);
        div.innerHTML = "";
        list.forEach(s => {
            const btn = document.createElement('div');
            btn.className = 'tag removable';
            btn.style.cursor = 'pointer';
            btn.innerText = s;
            if(char.spells[tier].includes(s)) {
                btn.style.borderColor = 'var(--gold-primary)';
                btn.style.color = '#fff';
                btn.style.backgroundColor = 'rgba(212, 175, 55, 0.1)';
            } else {
                btn.style.borderColor = '#444';
            }
            btn.onclick = () => {
                if(char.spells[tier].includes(s)) char.spells[tier] = char.spells[tier].filter(x=>x!==s);
                else {
                    if(char.spells[tier].length >= 3) { alert("è©²éšæ³•è¡“å·²æ»¿ 3 å€‹ï¼"); return; }
                    char.spells[tier].push(s);
                }
                renderSpellButtons();
                updateSpellDisplay();
            };
            div.appendChild(btn);
        });
        document.getElementById('cnt-'+tier).innerText = `${char.spells[tier].length}/3`;
    }

    function updateSpellDisplay() {
        const div = document.getElementById('spell-summary');
        const tags = document.getElementById('spell-tags');
        const all = [...char.spells.t0, ...char.spells.t1];
        if(all.length > 0) {
            div.style.display = 'block';
            tags.innerHTML = all.map(s => `<span class="tag spell">${s}</span>`).join('');
        } else {
            div.style.display = 'none';
        }
    }

    /* ================= FVTT JSON ç”Ÿæˆå™¨ ================= */
    function downloadFVTTJson() {
        if(char.coreSkills.length !== 6) { alert("è«‹é¸æ“‡ 6 å€‹æ ¸å¿ƒæŠ€èƒ½ï¼"); return; }
        
        const name = document.getElementById('char-name').value || "æœªå‘½åè‹±é›„";
        const finalAttrs = {};
        for(let k in char.calculatedAttrs) finalAttrs[k.toLowerCase()] = char.calculatedAttrs[k];
        
        const hp = parseInt(document.getElementById('val-hp').innerText);
        const wp = parseInt(document.getElementById('val-wp').innerText);
        const move = parseInt(document.getElementById('val-move').innerText);
        const enc = parseInt(document.getElementById('val-enc').innerText);

        const actor = {
            "name": name,
            "type": "character",
            "img": "icons/svg/mystery-man.svg",
            "system": {
                "attributes": {
                    "str": { "value": finalAttrs.str, "base": finalAttrs.str },
                    "con": { "value": finalAttrs.con, "base": finalAttrs.con },
                    "agl": { "value": finalAttrs.agl, "base": finalAttrs.agl },
                    "int": { "value": finalAttrs.int, "base": finalAttrs.int },
                    "wil": { "value": finalAttrs.wil, "base": finalAttrs.wil },
                    "cha": { "value": finalAttrs.cha, "base": finalAttrs.cha }
                },
                "hitPoints": { "value": hp, "max": hp, "base": hp },
                "willPoints": { "value": wp, "max": wp, "base": wp },
                "movement": { "value": move, "base": move },
                "encumbrance": { "value": 0, "max": enc },
                "bio": { "description": `<p>ç¨®æ—: ${RACES[char.race].name.split(' ')[0]} / è·æ¥­: ${PROFESSIONS[char.prof].name.split(' ')[0]}</p>` }
            },
            "items": []
        };

        const rData = RACES[char.race];
        let raceName = rData.name.split(' ')[0];
        let raceDesc = rData.ability;
        if(char.subrace && rData.subraces && rData.subraces[char.subrace]) {
            raceName += ` (${rData.subraces[char.subrace].name.split(' ')[0]})`;
            raceDesc += `<hr><strong>äºç¨®ç‰¹æ€§:</strong> ${rData.subraces[char.subrace].ability}`;
        }
        actor.items.push(createItem("kin", raceName, raceDesc));

        const pData = PROFESSIONS[char.prof];
        actor.items.push(createItem("profession", pData.name.split(' ')[0], `<p>æ ¸å¿ƒå±¬æ€§: ${pData.attr}</p>`));

        const allTrainedSkills = [...char.coreSkills, ...char.freeSkills, ...char.bonusSkills];
        allTrainedSkills.forEach(s => {
            const attrVal = finalAttrs[SKILL_ATTR_MAP[s].toLowerCase()] || 10;
            const base = getSkillBase(attrVal);
            actor.items.push(createSkillItem(s, SKILL_ATTR_MAP[s], base * 2));
        });

        if(char.heroKey && pData.heroAbilities) {
            const hNameFull = pData.heroAbilities[char.heroKey].split('ã€‘');
            const hName = hNameFull[0].replace('ã€','');
            const hDesc = hNameFull[1];
            actor.items.push(createAbilityItem(hName, hDesc, "heroic"));
        }
        if(char.extraKey && pData.extraOptions) {
            const exInfo = pData.extraOptions[char.extraKey];
            actor.items.push(createAbilityItem(exInfo.name, exInfo.desc, "kin"));
        }

        if(char.prof === 'shaman') {
            [...char.spells.t0, ...char.spells.t1].forEach(s => {
                actor.items.push(createSpellItem(s));
            });
        }

        const gearList = [];
        document.querySelectorAll('#inventory-list .tag.item').forEach(el => {
            let txt = el.innerText;
            if(!txt.includes("1D")) gearList.push(txt);
        });
        
        gearList.forEach(itemName => {
            let type = "item";
            if(itemName.includes("ç”²") || itemName.includes("è¡£") || itemName.includes("æˆ°ç”²")) type = "armor";
            else if(itemName.includes("ç›”") || itemName.includes("å¸½") || itemName.includes("æˆ°ç›”")) type = "helmet";
            else if(["åŠ", "æ–§", "å¼“", "çŸ›", "æ£", "åˆ€", "æ§", "å½ˆ", "ç®­", "å¹ç®­", "ç®­è¢‹", "æŠ•çŸ³ç¹©", "é¦¬å¤¸"].some(k => itemName.includes(k))) type = "weapon";
            
            actor.items.push(createGearItem(itemName, type));
        });

        const money = document.getElementById('money-input').value;
        if(money > 0) actor.items.push(createGearItem("éŠ€å¹£", "item", money));
        const food = document.getElementById('food-input').value;
        if(food > 0) actor.items.push(createGearItem("å£ç³§", "item", food));

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(actor, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `${name}_fvtt.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    /* --- PDF åŠŸèƒ½å‡½å¼ --- */
    function openPDFPreview() {
        const name = document.getElementById('char-name').value || "æœªå‘½åè‹±é›„";
        
        // 1. å¡«å…¥æ•¸æ“šåˆ°é è¦½è¦–çª—
        document.getElementById('pdf-char-name').innerText = name;
        const rName = RACES[char.race].name.split(' ')[0];
        const cName = PROFESSIONS[char.prof].name.split(' ')[0];
        document.getElementById('pdf-char-desc').innerText = `${rName} ${cName} (${document.getElementById('age-select').options[document.getElementById('age-select').selectedIndex].text})`;

        // å±¬æ€§
        let attrsHtml = "";
        for(let k in char.calculatedAttrs) {
            attrsHtml += `<div class="pdf-attr-row"><span class="pdf-attr-name">${k}</span><span class="pdf-attr-val">${char.calculatedAttrs[k]}</span></div>`;
        }
        document.getElementById('pdf-attrs').innerHTML = attrsHtml;

        // ç‹€æ…‹
        document.getElementById('pdf-hp').innerText = document.getElementById('val-hp').innerText;
        document.getElementById('pdf-wp').innerText = document.getElementById('val-wp').innerText;
        document.getElementById('pdf-mov').innerText = document.getElementById('val-move').innerText;
        document.getElementById('pdf-enc').innerText = document.getElementById('val-enc').innerText;
        document.getElementById('pdf-dmg').innerText = document.getElementById('val-dmg').innerText;

        // æŠ€èƒ½
        let skillsHtml = "";
        const allSkills = [...ALL_SKILLS];
        allSkills.forEach(s => {
            const attrKey = SKILL_ATTR_MAP[s] || "STR";
            const attrVal = char.calculatedAttrs[attrKey] || 10;
            const baseVal = getSkillBase(attrVal);
            let val = baseVal;
            let isTrained = false;
            
            if (char.coreSkills.includes(s) || char.freeSkills.includes(s) || char.bonusSkills.includes(s)) {
                val = baseVal * 2;
                isTrained = true;
            }
            
            skillsHtml += `<div class="pdf-skill-item ${isTrained ? 'trained' : ''}"><span>${s} <small style="color:#666">(${attrKey})</small></span><span>${val}</span></div>`;
        });
        document.getElementById('pdf-skills').innerHTML = skillsHtml;

        // èƒ½åŠ›
        let abilitiesHtml = "";
        const rData = RACES[char.race];
        abilitiesHtml += `<div class="pdf-ability-box"><div class="pdf-ability-name">${rData.name} ç‰¹æ€§</div><div class="pdf-ability-desc">${rData.ability}</div></div>`;
        if(char.subrace && rData.subraces[char.subrace]) {
             abilitiesHtml += `<div class="pdf-ability-box"><div class="pdf-ability-name">äºç¨®: ${rData.subraces[char.subrace].name}</div><div class="pdf-ability-desc">${rData.subraces[char.subrace].ability}</div></div>`;
        }
        const pData = PROFESSIONS[char.prof];
        if(char.heroKey && pData.heroAbilities) {
             abilitiesHtml += `<div class="pdf-ability-box"><div class="pdf-ability-name">è‹±é›„èƒ½åŠ›</div><div class="pdf-ability-desc">${pData.heroAbilities[char.heroKey]}</div></div>`;
        }
        if(char.extraKey && pData.extraOptions) {
             abilitiesHtml += `<div class="pdf-ability-box"><div class="pdf-ability-name">${pData.extraLabel}</div><div class="pdf-ability-desc">${pData.extraOptions[char.extraKey].desc}</div></div>`;
        }
        
        // æ³•è¡“
        if (char.prof === 'shaman') {
             const allSpells = [...char.spells.t0, ...char.spells.t1];
             if (allSpells.length > 0) {
                 abilitiesHtml += `<div class="pdf-ability-box" style="margin-top:10px; border-top:1px solid #444; padding-top:5px;"><div class="pdf-ability-name">æ³•è¡“</div><div class="pdf-inventory">${allSpells.map(s=>`<div class="pdf-item">${s}</div>`).join('')}</div></div>`;
             }
        }
        document.getElementById('pdf-abilities').innerHTML = abilitiesHtml;

        // ç‰¹å¾µ
        let traitsHtml = "";
        const weak = document.getElementById('weakness-select').value;
        if(weak && weak!=='random') traitsHtml += `<div class="pdf-attr-row"><span class="pdf-attr-name">å¼±é»</span><span>${weak}</span></div>`;
        const app = document.getElementById('appearance-select').value;
        if(app && app!=='random') traitsHtml += `<div class="pdf-attr-row"><span class="pdf-attr-name">å¤–è§€</span><span>${app}</span></div>`;
        const memInput = document.getElementById('memento-custom');
        const memVal = memInput.style.display==='none' ? document.getElementById('memento-select').value : memInput.value;
        if(memVal && memVal!=='random' && memVal!=='custom') traitsHtml += `<div class="pdf-attr-row"><span class="pdf-attr-name">ç´€å¿µç‰©</span><span>${memVal}</span></div>`;
        document.getElementById('pdf-traits').innerHTML = traitsHtml;

        // è£å‚™
        let gearHtml = "";
        document.querySelectorAll('#inventory-list .tag.item').forEach(el => {
            gearHtml += `<div class="pdf-item">${el.innerText}</div>`;
        });
        document.getElementById('pdf-gear').innerHTML = gearHtml;
        document.getElementById('pdf-money').innerText = document.getElementById('money-input').value;
        document.getElementById('pdf-food').innerText = document.getElementById('food-input').value;

        // é¡¯ç¤º Modal
        document.getElementById('pdf-preview-modal').classList.add('show');
    }

    function closePreview() {
        document.getElementById('pdf-preview-modal').classList.remove('show');
    }

    function confirmDownloadPDF() {
        const element = document.getElementById('pdf-content');
        const name = document.getElementById('char-name').value || "æœªå‘½åè‹±é›„";
        
        const opt = {
          margin:       0,
          filename:     `${name}_character_sheet.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#111' },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // éš±è— toolbar é¿å…è¢«æˆªåœ–åˆ°
        document.querySelector('.pdf-toolbar').style.display = 'none';
        
        html2pdf().set(opt).from(element).save().then(() => {
            document.querySelector('.pdf-toolbar').style.display = 'flex';
            closePreview();
        });
    }

    function createItem(type, name, desc) { return { "name": name, "type": type, "img": `icons/svg/${type === 'kin' ? 'mystery-man' : 'book'}.svg`, "system": { "description": desc } }; }
    function createSkillItem(name, attr, val) { const isWeapon = ["æ–§","æ£æ£’","åŠ","å°åˆ€","å¼“","æŠ•æ§å™¨","æŠ•çŸ³ç¹©","å¹ç®­ç­’","çŸ›"].includes(name); return { "name": name, "type": "skill", "img": "icons/svg/sword.svg", "system": { "description": "", "attribute": attr.toLowerCase(), "skillType": isWeapon ? "weapon" : "core", "value": val } }; }
    function createAbilityItem(name, desc, type) { return { "name": name, "type": "ability", "img": "icons/svg/aura.svg", "system": { "description": desc, "abilityType": type } }; }
    function createSpellItem(name) { return { "name": name, "type": "spell", "img": "icons/svg/daze.svg", "system": { "school": "general", "rank": 0 } }; }
    function createGearItem(name, type, qty=1) { let icon = "item-bag"; if(type === 'weapon') icon = "sword"; if(type === 'armor') icon = "chest"; if(type === 'helmet') icon = "helmet"; return { "name": name, "type": type, "img": `icons/svg/${icon}.svg`, "system": { "quantity": parseInt(qty) } }; }

    init();
</script>
</body>
</html>
